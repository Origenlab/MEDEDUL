---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import BlogArchive from '@/components/blog/BlogArchive.astro';
import Hero from '@/components/global/Hero.astro';
import CTAServices from '@/components/global/CTAServices.astro';
import { getCollection } from 'astro:content';
import { categoryMeta } from '@/content/config';
import { sortBlogPosts } from '@/lib/blogSorting';

export async function getStaticPaths() {
  const allPosts = sortBlogPosts(await getCollection('blog', ({ data }) => !data.draft));
  const categories = [...new Set(allPosts.map(post => post.data.category))];

  return categories.map((category) => {
    const categoryPosts = sortBlogPosts(
      allPosts.filter(post => post.data.category === category)
    );

    return {
      params: { category },
      props: { category, categoryPosts, allPosts }
    };
  });
}

const { category, categoryPosts, allPosts } = Astro.props;
const meta = categoryMeta[category as keyof typeof categoryMeta];
const categoryName = meta?.name || category;

const breadcrumbItems = [
  { name: 'Blog', url: '/blog' },
  { name: categoryName, url: `/blog/categoria/${category}` }
];

const categories = [...new Set(allPosts.map((post: any) => post.data.category))];
const featuredPosts = allPosts.slice(0, 4);
---

<BaseLayout
  title={`${categoryName} - Articulos sobre Mesas de Dulces | Mededul`}
  description={`Descubre todos nuestros articulos sobre ${String(categoryName).toLowerCase()}. Consejos, tendencias e inspiracion para tu mesa de dulces.`}
  includeBlogStyles={true}
>
  <Breadcrumbs items={breadcrumbItems} />

  <Hero
    title={categoryName}
    subtitle={meta?.description || `Articulos sobre ${String(categoryName).toLowerCase()} para tu mesa de dulces`}
    showCTA={false}
  />

  <BlogArchive
    posts={categoryPosts}
    featuredPosts={featuredPosts}
    categories={categories}
    currentPage={1}
    totalPages={1}
  />

  <CTAServices
    href="/contacto"
    badge="Asesoria por Categoria"
    title="Lleva Tu Categoria a un Resultado"
    titleHighlight="Profesional"
    text={`Si te interesa ${String(categoryName).toLowerCase()}, te ayudamos a convertir esa referencia en una propuesta real para tu evento.`}
    buttonText="Solicitar Asesoria"
  />
</BaseLayout>
