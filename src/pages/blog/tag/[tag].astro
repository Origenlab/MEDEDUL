---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import BlogArchive from '@/components/blog/BlogArchive.astro';
import Hero from '@/components/global/Hero.astro';
import CTAServices from '@/components/global/CTAServices.astro';
import { getCollection } from 'astro:content';
import { sortBlogPosts } from '@/lib/blogSorting';

export async function getStaticPaths() {
  const MIN_TAG_POSTS = 3;
  const allPosts = sortBlogPosts(await getCollection('blog', ({ data }) => !data.draft));
  const tagMap = new Map<string, { originalTag: string; posts: typeof allPosts }>();

  allPosts.forEach((post) => {
    post.data.tags?.forEach((tag) => {
      const normalizedTag = tag.toLowerCase().replace(/\s+/g, '-');
      if (!tagMap.has(normalizedTag)) {
        tagMap.set(normalizedTag, { originalTag: tag, posts: [] as typeof allPosts });
      }
      tagMap.get(normalizedTag)!.posts.push(post);
    });
  });

  return Array.from(tagMap.entries())
    .filter(([, data]) => data.posts.length >= MIN_TAG_POSTS)
    .map(([tag, data]) => ({
      params: { tag },
      props: {
        tagName: data.originalTag,
        tagSlug: tag,
        tagPosts: sortBlogPosts(data.posts),
        allPosts
      }
    }));
}

const { tagName, tagSlug, tagPosts, allPosts } = Astro.props;

const breadcrumbItems = [
  { name: 'Blog', url: '/blog' },
  { name: `#${tagName}`, url: `/blog/tag/${tagSlug}` }
];

const categories = [...new Set(allPosts.map((post: any) => post.data.category))];
const featuredPosts = allPosts.slice(0, 4);
---

<BaseLayout
  title={`${tagName} - Articulos | Mededul`}
  description={`Articulos etiquetados con ${tagName}. Encuentra informacion para planificar mejor tu evento.`}
  includeBlogStyles={true}
>
  <Breadcrumbs items={breadcrumbItems} />

  <Hero
    title={tagName}
    subtitle={`Articulos relacionados con ${tagName}`}
    showCTA={false}
  />

  <BlogArchive
    posts={tagPosts}
    featuredPosts={featuredPosts}
    categories={categories}
    currentPage={1}
    totalPages={1}
  />

  <CTAServices
    href="/contacto"
    badge="Asesoria por Etiqueta"
    title="Convierte Esta Idea en una"
    titleHighlight="Propuesta Real"
    text={`Si este tema (${tagName}) se relaciona con tu evento, te ayudamos a aterrizarlo con una cotizacion profesional.`}
    buttonText="Hablar con un Asesor"
  />
</BaseLayout>
