---
// BlogPostLayout - Professional Blog Article Layout
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import JsonLd from '@/components/seo/JsonLd.astro';
import Hero from '@/components/global/Hero.astro';
import SectionHeader from '@/components/global/SectionHeader.astro';
import FAQ from '@/components/global/FAQ.astro';
import ArticleSidebar from '@/components/blog/ArticleSidebar.astro';
import ArticleCTA from '@/components/content/ArticleCTA.astro';
import { categoryMeta } from '@/content/config';
import { getCdnSrcSet, getCdnUrl } from '@/lib/cdn';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { title, description, category, heroImage, heroImageAlt, tags, faqs } = post.data;
const articleHeroSrc = heroImage ? getCdnUrl(heroImage, { w: 960, q: 82 }) : '';
const articleHeroSrcSet = heroImage ? getCdnSrcSet(heroImage, [640, 960, 1280, 1600], { q: 82 }) : '';
const articleHeroSizes = '(max-width: 768px) 100vw, (max-width: 1400px) 70vw, 960px';
const MIN_TAG_POSTS = 3;

const publishedPosts = await getCollection('blog', ({ data }) => !data.draft);
const tagCounts = new Map<string, number>();

publishedPosts.forEach((entry) => {
  entry.data.tags?.forEach((tag) => {
    const normalizedTag = tag.toLowerCase().replace(/\s+/g, '-');
    tagCounts.set(normalizedTag, (tagCounts.get(normalizedTag) || 0) + 1);
  });
});

const enabledTagSlugs = Array.from(tagCounts.entries())
  .filter(([, count]) => count >= MIN_TAG_POSTS)
  .map(([slug]) => slug);

const siteUrl = Astro.site?.toString() || 'https://mesas-de-dulces.com';
const articleUrl = `${siteUrl}/blog/${post.slug}`;
const categoryInfo = categoryMeta[category as keyof typeof categoryMeta];

const breadcrumbItems = [
  { name: 'Blog', url: '/blog' },
  { name: categoryInfo?.name || category, url: `/blog/categoria/${category}` },
  { name: title, url: articleUrl }
];
---

<BaseLayout
  title={title}
  description={description}
  ogType="article"
  article={{ category: categoryInfo?.name || category, tags }}
  includeArticleStyles={true}
  showGlobalCta={false}
>
  <JsonLd
    type="Article"
    data={{ title, description, image: getCdnUrl(heroImage), url: articleUrl }}
  />
  {faqs && faqs.length > 0 && <JsonLd type="FAQPage" data={{ faqs }} />}

  <Breadcrumbs items={breadcrumbItems} />

  <Hero
    title={title}
    subtitle={`${categoryInfo?.icon || 'üìù'} ${categoryInfo?.name || category}`}
    description={description}
    showCTA={false}
  />

  <!-- MAIN ARTICLE SECTION -->
  <section class="article-section">
    <div class="container-1400">
      <div class="article-layout">

        <!-- ARTICLE CONTENT -->
        <article class="article-main">
          {heroImage && (
            <div class="article-featured-image">
              <img
                src={articleHeroSrc}
                srcset={articleHeroSrcSet}
                sizes={articleHeroSizes}
                alt={heroImageAlt || title}
                width="960"
                height="600"
                loading="eager"
                decoding="async"
                fetchpriority="high"
              />
            </div>
          )}

          <div class="article-content">
            <slot />
          </div>

          {faqs && faqs.length > 0 && (
            <section class="article-faqs">
              <SectionHeader
                title="Preguntas Frecuentes del Articulo"
                titleHighlight="Frecuentes"
                subtitle="Resolvemos las dudas clave relacionadas con este contenido"
              />
              <FAQ items={faqs} id={`faq-${post.slug}`} />
            </section>
          )}

          <section class="article-footer-cta" aria-label="Llamada a la accion del articulo">
            <ArticleCTA
              title="Asesoria especializada para tu evento en CDMX"
              description="Convierte lo que viste en este articulo en una propuesta real con diseno, operacion y acompanamiento profesional de MEDEDUL."
              buttonText="Solicitar cotizacion"
              buttonUrl="https://wa.me/525525226442?text=Hola%2C%20quiero%20asesoria%20para%20mi%20evento%20en%20CDMX"
              variant="brand-whatsapp"
            />
          </section>
        </article>

        <ArticleSidebar tags={tags} enabledTagSlugs={enabledTagSlugs} />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* ========================================
     CONTAINER 1400px
     ======================================== */
  .container-1400 {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 40px;
  }

  /* ========================================
     ARTICLE SECTION - Fondo general sin tarjeta
     ======================================== */
  .article-section {
    background: #fff;
    padding: 50px 0 80px;
  }

  .article-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 60px;
    align-items: start;
  }

  /* ========================================
     ARTICLE MAIN CONTENT - Sin tarjeta
     ======================================== */
  .article-main {
    /* Sin fondo, sin sombra - contenido directo */
  }

  .article-featured-image {
    width: 100%;
    height: 450px;
    overflow: hidden;
    border-radius: 20px;
    margin-bottom: 45px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.12);
  }

  .article-featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-content {
    /* Sin padding extra - contenido directo */
  }

  /* ========================================
     ARTICLE TYPOGRAPHY (MDX Content)
     ======================================== */
  .article-content :global(p) {
    font-size: 1.1rem;
    line-height: 1.9;
    color: #444;
    margin-bottom: 24px;
  }

  .article-content :global(h2) {
    font-size: 1.6rem;
    font-weight: 800;
    color: #1a1a1a;
    margin: 50px 0 24px;
    padding: 20px 25px;
    background: linear-gradient(135deg, rgba(233, 30, 140, 0.08) 0%, rgba(233, 30, 140, 0.02) 100%);
    border: 1px solid rgba(209, 0, 122, 0.22);
    border-radius: 12px;
  }

  .article-content :global(h2:first-child) {
    margin-top: 0;
  }

  .article-content :global(h3) {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 30px 0 16px;
    padding: 16px 20px;
    border-radius: 10px;
  }

  /* Problem h3 (contains ‚ùå) */
  .article-content :global(h3:nth-of-type(odd)) {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.08) 0%, rgba(231, 76, 60, 0.02) 100%);
    border: 1px solid rgba(231, 76, 60, 0.25);
    color: #c0392b;
  }

  /* Solution h3 (contains ‚úÖ) */
  .article-content :global(h3:nth-of-type(even)) {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(39, 174, 96, 0.02) 100%);
    border: 1px solid rgba(39, 174, 96, 0.25);
    color: #1e8449;
  }

  .article-content :global(strong) {
    color: #1a1a1a;
    font-weight: 700;
  }

  .article-content :global(a) {
    color: #D1007A;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin: 24px 0;
    padding-left: 28px;
  }

  .article-content :global(li) {
    font-size: 1.05rem;
    line-height: 1.8;
    color: #444;
    margin-bottom: 12px;
  }

  .article-content :global(hr) {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(233, 30, 140, 0.2), transparent);
    margin: 45px 0;
  }

  /* ========================================
     FAQs - Sin contenedor
     ======================================== */
  .article-faqs {
    margin-top: 60px;
    padding-top: 50px;
    border-top: 2px solid #f0f0f0;
  }

  .article-footer-cta {
    margin-top: 26px;
  }

  /* ========================================
     RESPONSIVE
     ======================================== */
  @media (max-width: 1200px) {
    .container-1400 {
      padding: 0 30px;
    }

    .article-layout {
      grid-template-columns: 1fr 320px;
      gap: 45px;
    }
  }

  @media (max-width: 1024px) {
    .article-layout {
      grid-template-columns: 1fr;
      gap: 50px;
    }
  }

  @media (max-width: 768px) {
    .container-1400 {
      padding: 0 20px;
    }

    .article-section {
      padding: 35px 0 50px;
    }

    .article-featured-image {
      height: 280px;
      margin-bottom: 35px;
      border-radius: 16px;
    }

    .article-content :global(h2) {
      font-size: 1.35rem;
      padding: 16px 20px;
    }

    .article-content :global(h3) {
      font-size: 1.1rem;
      padding: 14px 16px;
    }

    .article-content :global(p) {
      font-size: 1rem;
    }

    .article-faqs {
      margin-top: 45px;
      padding-top: 40px;
    }

  }

  @media (max-width: 480px) {
    .article-featured-image {
      height: 220px;
      margin-bottom: 30px;
      border-radius: 12px;
    }

    .article-content :global(h2) {
      font-size: 1.2rem;
      padding: 14px 16px;
      margin: 35px 0 20px;
    }

    .article-content :global(h3) {
      font-size: 1rem;
      padding: 12px 14px;
    }

    .article-faqs {
      margin-top: 40px;
      padding-top: 35px;
    }

  }
</style>
